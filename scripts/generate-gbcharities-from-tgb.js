// scripts/generate-gbcharities-from-tgb.js
// Node 18+ recommended. Non-destructive by default: writes gbcharities.tgb.generated.ts
import fs from 'node:fs';
import path from 'node:path';
import { getAccessToken, tgbBaseUrl } from '../server/tgb/auth.js';

const DEFAULT_OUT_FILENAME = 'gbcharities.tgb.generated.ts';
const OUT_DIR = path.resolve(process.cwd(), 'src/chains/evm/config');
const OUT_PATH = (() => {
  const outArg = process.argv.find(a => a.startsWith('--out='));
  if (outArg) return path.isAbsolute(outArg.split('=')[1]) ? outArg.split('=')[1] : path.resolve(process.cwd(), outArg.split('=')[1]);
  return path.join(OUT_DIR, DEFAULT_OUT_FILENAME);
})();

// --- chosen 12 sandbox orgs (from your provided list) ---
const TARGET_NAMES = [
  'Uncommon Giving Sandbox',
  'OnboardOrg In Sandbox',
  'Alveus Sanctuary Sandbox',
  'CSU Long Beach (Sandbox)',
  'World Child Cancer Sandbox',
  'GoFundMe Sandbox',
  'Young Americans for Liberty Foundation Sandbox',
  'goDonate Sandbox - GBP',
  'ALS Network - Sandbox',
  'Charity On Top Sandbox',
  'The Giving Block Demo',
  'Schwab Charitable - DAF Giving 360'
];

// liberal name matching helper
function matchesTarget(orgName = '', target = '') {
  const a = String(orgName).toLowerCase().replace(/[^a-z0-9]/g, '');
  const b = String(target).toLowerCase().replace(/[^a-z0-9]/g, '');
  return a === b || a.includes(b) || b.includes(a);
}

// fetch orgs from TGB endpoint
async function fetchOrgs(bearer) {
  const base = tgbBaseUrl();
  const url = `${base}/v1/organizations/list`;
  const res = await fetch(url, { headers: { Authorization: bearer, Accept: 'application/json' }});
  const raw = await res.text().catch(() => '');
  let json = null;
  try { json = JSON.parse(raw); } catch (e) { json = raw; }
  if (!res.ok) {
    const tmpDir = path.resolve(process.cwd(), 'tmp');
    if (!fs.existsSync(tmpDir)) fs.mkdirSync(tmpDir, { recursive: true });
    fs.writeFileSync(path.join(tmpDir, 'tgb_orgs_error.json'), raw, 'utf8');
    throw { status: res.status, raw, json };
  }
  const orgs = json?.data?.organizations ?? json?.data ?? json?.organizations ?? (Array.isArray(json) ? json : []);
  if (!Array.isArray(orgs)) throw new Error('Unexpected TGB response shape; see tmp/tgb_orgs_error.json');
  return orgs;
}

// find matches for our TARGET_NAMES
function findMatches(orgs) {
  const matches = [];
  const notFound = [];
  for (const target of TARGET_NAMES) {
    let found = orgs.find(o => matchesTarget(o.name ?? '', target));
    // try other fields if needed
    if (!found) found = orgs.find(o => matchesTarget(o.uuid ?? '', target) || matchesTarget(String(o.id ?? ''), target));
    if (found) matches.push(found);
    else notFound.push(target);
  }
  // unique by id/uuid
  const unique = matches.reduce((acc, cur) => {
    const id = String(cur.id ?? cur.uuid ?? '');
    if (!acc.find(x => String(x.id) === id)) acc.push(cur);
    return acc;
  }, []);
  return { matchedOrgs: unique, notFound };
}

// map org object to Charity shape with website & logo where available
function buildCharitiesArray(orgs) {
  return orgs.map(o => {
    const id = String(o.id ?? o.uuid ?? '');
    const logoUrl = o.logo ?? o.logoUrl ?? o.icon ?? '';
    // try several common website keys
    const website = o.website ?? o.url ?? o.websiteUrl ?? o.profileUrl ?? o.website_link ?? '';
    const blurb = o.short_description ?? o.description ?? (o.country ? `Country: ${o.country}` : '');
    return {
      id,
      name: o.name ?? `Org ${id}`,
      logoUrl: logoUrl || '',
      website: website || '',
      blurb: blurb || '',
      uuid: o.uuid ?? null,
      country: o.country ?? null
    };
  });
}

function generateTsFile(charities, sourceUrl) {
  return `/** Auto-generated by scripts/generate-gbcharities-from-tgb.js
 *  Source: ${sourceUrl}
 *  Generated: ${new Date().toISOString()}
 *
 *  Note: this file is safe to commit; tokens must NOT be committed.
 */

export type Charity = {
  id: string;
  name: string;
  logoUrl?: string;
  website?: string;
  blurb?: string;
  uuid?: string | null;
  country?: string | null;
};

export const CHARITIES: Charity[] = ${JSON.stringify(charities, null, 2)};

export const getCharityById = (id?: string | null) =>
  CHARITIES.find(c => c.id === id);

export const getOrgIdByName = (name?: string | null) => {
  if (!name) return undefined;
  const norm = name.trim().toLowerCase();
  return CHARITIES.find(c => c.name.trim().toLowerCase() === norm)?.id;
};

export const searchCharities = (query: string, limit = 10) => {
  const q = query.trim().toLowerCase();
  if (!q) return CHARITIES.slice(0, limit);
  return CHARITIES.filter(c => c.name.toLowerCase().includes(q)).slice(0, limit);
};
`;
}

(async function main() {
  console.log('Starting TGB charities generator (safe, non-destructive by default).');

  // try to resolve token: getAccessToken() internally has fallbacks (TGB_STATIC_BEARER, /tmp/tgb_login.json)
  let bearer;
  try {
    bearer = await getAccessToken(); // returns "Bearer x..." or throws
  } catch (e) {
    // helpful message
    console.error('getAccessToken() failed:', e?.message || e);
    console.error('Quickfix: export TGB_STATIC_BEARER="Bearer <token>" (token from /tmp/tgb_login.json) and retry.');
    process.exit(1);
  }

  console.log('Using token (preview):', `${String(bearer).slice(0, 20)}...`);
  try {
    const orgs = await fetchOrgs(bearer);
    const { matchedOrgs, notFound } = findMatches(orgs);
    console.log(`Matched ${matchedOrgs.length} org(s); ${notFound.length} not found.`);
    if (notFound.length) console.warn('Not found (these names were not present in sandbox):', notFound);

    const charities = buildCharitiesArray(matchedOrgs);
    const ts = generateTsFile(charities, `${tgbBaseUrl()}/v1/organizations/list`);
    fs.mkdirSync(path.dirname(OUT_PATH), { recursive: true });
    fs.writeFileSync(OUT_PATH, ts, 'utf8');
    console.log(`Wrote generated file: ${OUT_PATH}`);
    process.exit(0);
  } catch (err) {
    if (err && err.status === 403) {
      console.error('TGB returned 403 Forbidden. Check token permissions and tmp/tgb_orgs_error.json for details.');
      process.exit(2);
    }
    console.error('Unexpected error:', err?.message || err);
    process.exit(1);
  }
})();


